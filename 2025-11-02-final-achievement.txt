================================================================================
2025年11月2日 最終成果レポート
4足歩行ゴールキーパーロボット - カメラ＆Arduino連携完成
================================================================================

## 📊 全体進捗

Phase 1: カメラセットアップ ✅ 完了
Phase 2: TPU動作確認 ✅ 完了
Phase 3: Arduino連携 ✅ 完了（本日完成）
Phase 4: リアルタイムボール検出 ✅ 完了
Phase 5: カメラ追従制御 🔄 実装開始
Phase 6: 2D位置マッピング ⏳ 未着手
Phase 7: 軌道予測 ⏳ 未着手
Phase 8: 統合テスト ⏳ 未着手

================================================================================
## 🎯 本日の主要成果
================================================================================

### 1. カメラストリーミング完成版（40 FPS達成）

**問題発見と解決:**
- 課題：300x300解像度で虹色のアーティファクトが発生
- 原因：IMX708センサーが非標準解像度(300x300)非対応
  → ピクセルフォーマットのストライド（メモリレイアウト）崩壊
  → RGBチャンネルのバイトアラインメントずれ
- 解決：640x480標準解像度でキャプチャ → 300x300にリサイズ

**パフォーマンス:**
✅ 40 FPS達成（目標30 FPS大幅超過）
✅ TPU推論時間: 15-20ms
✅ ボール検出精度: 高精度（静止・転がる両対応）

**技術的改善:**
- 検出しきい値: 50% → 30%（感度向上）
- Mouse (COCO class 73) をボールとして検出
  → 静止ボール: sports ball (class 36)
  → 転がるボール: mouse (class 73)
  → 両方を赤色で「Ball」と表示

**ファイル:**
- scripts/camera_stream_tpu_300.py （完成版メインスクリプト）

**コミット:**
- d4e9a68: feat: 完成版カメラストリーミング - 40 FPS高精度ボール検出達成

================================================================================
### 2. Arduino連携の完全実装

**ハードウェア接続:**
✅ Arduino Uno ←USB→ RaspberryPi 4 (/dev/ttyACM0)
✅ PCA9685サーボドライバ（I2C 0x40）
✅ HC-SR04超音波距離センサー（Trig:9, Echo:10）
✅ サーボモータ 0~7番 全チャンネル動作確認

**通信プロトコル設計:**
RaspberryPi → Arduino:
  - サーボ制御: S[ID:2桁][ANGLE:3桁]\n
    例: S00090 = サーボ0を90度に
  - 距離測定: D\n

Arduino → RaspberryPi:
  - 成功: OK\n
  - エラー: ERR\n
  - 距離: D[VALUE:5桁]\n
    例: D00135 = 13.5cm

**実装ファイル:**
Arduino側:
  - arduino/robot_controller/robot_controller.ino
    → メインコントローラ（60Hz、150-600 PWM）
  - arduino/servo_test/servo_test.ino
    → サーボドライバテストプログラム

RaspberryPi側:
  - src/arduino/serial_controller.py
    → シリアル通信ライブラリ
    → send_servo_command(), set_pan_tilt(), read_distance()
  - src/arduino/__init__.py
    → SerialController エクスポート

テスト:
  - tests/test_arduino_connection.py
    → 自動接続テスト（サーボ・距離センサー）
  - tests/run_servo_test.py
    → サーボスイープテスト実行

**動作確認結果:**
✅ シリアル通信: 正常（9600 baud、レイテンシ<10ms）
✅ Pan/Tiltサーボ: 正常動作
✅ 距離センサー: 135cm正確に測定
✅ 全サーボ（0-7）スイープテスト: 成功

**開発環境セットアップ:**
✅ arduino-cli on RaspberryPi インストール完了
✅ Arduino AVR core v1.8.6
✅ Adafruit PWM Servo Driver Library v3.0.2
✅ ワンコマンドでコンパイル＆アップロード可能

**コミット:**
- d4740df: feat: Phase 3完了 - Arduino連携とサーボ制御実装

================================================================================
## 🔧 技術的詳細・重要な知見
================================================================================

### カメラ解像度問題の詳細

**症状:**
- 300x300解像度設定時、虹色のぐちゃぐちゃな映像が表示

**根本原因:**
RaspberryPi Camera Module 3 (IMX708センサー) の対応解像度:
  - 4608x2592 (フル解像度)
  - 2304x1296
  - 1920x1080
  - 1280x720
  - 640x480
  → 300x300は非対応

非標準解像度を設定すると:
  1. picamera2が内部でクロップ/リサイズを試みる
  2. ピクセルフォーマットのストライド（メモリレイアウト）が正しく処理されない
  3. RGBカラーチャンネルのバイトアラインメントがずれる
  4. → 虹色のアーティファクト発生

**正しいアプローチ:**
標準解像度(640x480)でキャプチャ → ソフトウェアで300x300にリサイズ
  - リサイズコスト: 約2-3ms (cv2 + INTER_LINEAR)
  - 期待FPS: 40-45 FPS
  - 実測FPS: 40 FPS ✅

### PCA9685サーボドライバ設定

**walk_program.inoとの整合性:**
- 周波数: 60Hz（50Hzから変更）
- PWM値範囲: 150~600
  - 150 = 0度
  - 375 = 90度（NEUTRAL）
  - 600 = 180度

**サーボチャンネル構成（4足歩行ロボット）:**
FL (Front Left):  0(hip), 1(knee)
FR (Front Right): 2(hip), 3(knee)
BL (Back Left):   8(hip), 5(knee)
BR (Back Right):  6(hip), 7(knee)

Pan/Tilt用途:
  - サーボ0: Pan（左右）
  - サーボ1: Tilt（上下）

### シリアル通信の最適化

**バッファクリア処理:**
Arduino起動時に "Arduino initialized" メッセージが送信される
→ 初回コマンドがこのメッセージを誤読してエラーになる

解決策:
  1. 接続後2秒待機（Arduino起動時間）
  2. reset_input_buffer()、reset_output_buffer()実行
  3. 残存メッセージを読み捨て

result:
  - 初回コマンドから正常動作 ✅

================================================================================
## 📁 プロジェクト構造
================================================================================

robot_pk/
├── arduino/
│   ├── robot_controller/
│   │   └── robot_controller.ino      # メインコントローラ（60Hz、通信対応）
│   └── servo_test/
│       └── servo_test.ino             # サーボテストプログラム
├── src/
│   ├── camera/
│   │   └── camera_controller.py      # カメラ制御（640x480）
│   ├── arduino/
│   │   ├── __init__.py
│   │   └── serial_controller.py      # シリアル通信ライブラリ
│   └── tracking/                      # 🆕 追従制御（実装開始）
│       ├── __init__.py
│       ├── pid_controller.py          # PIDコントローラ
│       └── tracker.py                 # ボールトラッカー
├── scripts/
│   └── camera_stream_tpu_300.py      # 完成版ストリーミング（40 FPS）
├── tests/
│   ├── test_arduino_connection.py    # Arduino接続テスト
│   └── run_servo_test.py             # サーボテスト実行
└── models/
    ├── ssd_mobilenet_v2_coco_quant_postprocess_edgetpu.tflite
    └── coco_labels.txt

================================================================================
## 📈 性能指標
================================================================================

### カメラ＆検出システム
- FPS: 40 FPS（目標30 FPS超過）
- 解像度: 640x480 → 300x300
- TPU推論時間: 15-20ms
- 検出しきい値: 30%
- 検出精度: 高精度（静止・転がる両対応）

### Arduino通信
- シリアルポート: /dev/ttyACM0
- ボーレート: 9600 baud
- レイテンシ: <10ms
- 通信成功率: 100%

### サーボ制御
- PCA9685周波数: 60Hz
- PWM範囲: 150-600
- 角度範囲: 0-180度
- 応答時間: 即座

================================================================================
## 🎓 学んだこと・ベストプラクティス
================================================================================

1. **非標準解像度の危険性**
   カメラセンサーのネイティブ解像度を確認してから設定する
   非標準解像度は予期しない問題を引き起こす可能性がある

2. **開発環境の一元化**
   RaspberryPi上でarduino-cliを使うことで:
   - ファイル転送不要
   - Git管理が容易
   - 開発サイクル高速化
   - 自動化可能

3. **段階的テスト**
   - ハードウェア単体テスト（サーボテスト）
   - 通信プロトコルテスト（接続テスト）
   - 統合テスト（実際の動作確認）
   この順序で進めることで問題の切り分けが容易

4. **シリアル通信のバッファ管理**
   起動メッセージなどの予期しないデータをクリアする処理が重要

5. **既存コードの活用**
   walk_program.inoの設定値を参照することで、
   正しいPWM値や周波数を即座に把握できた

================================================================================
## 🚀 次のステップ（Phase 5: カメラ追従制御）
================================================================================

### 実装予定

1. **PIDコントローラ** ✅ 実装開始
   - src/tracking/pid_controller.py
   - P（比例）、I（積分）、D（微分）制御
   - サーボ角度調整の最適化

2. **ボールトラッカー** ⏳ 次のタスク
   - src/tracking/tracker.py
   - ボール位置 → 画面中央との誤差計算
   - PID出力 → サーボ角度変換

3. **統合システム** ⏳ 次のタスク
   - scripts/camera_tracking.py
   - カメラストリーミング + TPU検出 + サーボ制御
   - リアルタイムでボールを画面中央に追従

### 目標

✅ ボールが画面中央に常に位置するように制御
✅ PID制御で滑らかな追従動作
✅ 30 FPS以上でリアルタイム動作

================================================================================
## 📊 Git コミット履歴
================================================================================

d4740df (HEAD -> main) feat: Phase 3完了 - Arduino連携とサーボ制御実装
d4e9a68 feat: 完成版カメラストリーミング - 40 FPS高精度ボール検出達成
8d3e639 fix: TPUボール検出の完全修正とFPS最適化調査
2348325 feat: Achieve 40+ FPS camera + TPU integration with Python 3.9

================================================================================
## 💡 重要な設定値まとめ
================================================================================

### カメラ設定
- 解像度: 640x480（標準解像度を使用）
- フレームレート: 30 FPS
- リサイズ: cv2.resize + INTER_LINEAR (640x480 → 300x300)

### TPU設定
- モデル: ssd_mobilenet_v2_coco_quant_postprocess_edgetpu.tflite
- 入力サイズ: 300x300
- 検出しきい値: 0.3 (30%)
- ターゲットクラス: 36 (sports ball), 73 (mouse)

### Arduino設定
- ボーレート: 9600
- I2Cアドレス: 0x40 (PCA9685)
- サーボ周波数: 60Hz
- PWM範囲: 150-600

### 距離センサー設定
- センサー: HC-SR04
- Trigピン: 9
- Echoピン: 10
- 有効範囲: 2-400cm

================================================================================
## 🔗 参考資料・ドキュメント
================================================================================

- CLAUDE.md: プロジェクト全体設計
- blueprint.txt: 詳細実装計画
- walk_program.ino: サーボ設定リファレンス

================================================================================
## ✅ 達成項目チェックリスト
================================================================================

Phase 1-2 (カメラ・TPU):
[✅] RaspberryPi Camera Module 3 動作確認
[✅] Edge TPU (Google Coral) 動作確認
[✅] 30+ FPS達成（実測40 FPS）
[✅] ボール検出精度確保（静止・転がる両対応）

Phase 3 (Arduino連携):
[✅] Arduino Uno接続確認
[✅] シリアル通信プロトコル設計・実装
[✅] PCA9685サーボドライバ動作確認
[✅] サーボ0-7番動作確認
[✅] HC-SR04距離センサー動作確認
[✅] arduino-cli環境構築
[✅] 自動テストスクリプト作成

Phase 5 (追従制御):
[🔄] PIDコントローラ実装（開始）
[⏳] ボールトラッカー実装
[⏳] 統合システム実装
[⏳] リアルタイム追従テスト

================================================================================
本日の開発は非常に生産的で、大きな進展がありました。
40 FPSのカメラストリーミングとArduino連携の完成により、
ボール追従制御（Phase 5）への準備が整いました。

次回は、PIDコントローラとボールトラッカーの実装を完成させ、
実際にサーボでカメラを動かしてボールを追従させる統合テストを行います。

作成日時: 2025-11-02
================================================================================
